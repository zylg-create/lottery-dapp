<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>Lottery DApp Demo</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
@keyframes confetti {
  0% { transform: translateY(0) rotate(0deg); opacity:1;}
  100% { transform: translateY(500px) rotate(360deg); opacity:0;}
}
.confetti {
  position: absolute;
  width: 10px;
  height: 10px;
  animation: confetti 1s linear forwards;
  border-radius: 50%;
}
</style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen relative">

<div class="bg-white shadow-lg rounded-2xl p-10 w-full max-w-md text-center relative z-10">
    <h2 class="text-2xl font-bold mb-6">ğŸ² æŠ½å¥– DApp Demo</h2>

    <button id="connectWallet" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-full mb-4">
        è¿æ¥é’±åŒ…
    </button>

    <p id="networkStatus" class="text-sm text-red-500 mb-4"></p>

    <div class="my-4">
        <input type="number" id="ethAmount" placeholder="ETH è¾“å…¥ (0.01 æœ€å°‘)"
               class="border border-gray-300 rounded-full px-4 py-2 w-2/3 text-center mr-2">
        <button id="enterLottery" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-full">
            å‚ä¸æŠ½å¥–
        </button>
    </div>

    <button id="pickWinner" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-full mb-6">
        å¹¸è¿è½¬è½¬è½¬
    </button>

    <div class="text-left space-y-2">
        <p id="status" class="font-medium">çŠ¶æ€: æœªè¿æ¥</p>
        <p id="players" class="font-medium">ç©å®¶: </p>
        <p id="balance" class="font-medium">å¥–æ± ä½™é¢: 0 ETH</p>
        <!-- æ˜¾ç¤ºè·å¥–è€… -->
        <p id="winner" class="font-bold text-purple-600 mt-4"></p>
    </div>
</div>

<script type="module">
import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.min.js";

let provider, signer, contract, refreshInterval;

const contractAddress = "0x05470664d241bc11188d07C2c4d24963696a1BEB";
const contractNetworkId = 11155111; // Sepolia
const contractABI = [
    "function enter() payable",
    "function getPlayers() view returns (address[])",
    "function pickWinner()",
    "function manager() view returns (address)",
    "event WinnerPicked(address winner)"
];

function setStatus(msg) {
    document.getElementById("status").innerText = "çŠ¶æ€: " + msg;
}

async function updatePlayersAndBalance() {
    if (!contract) return;
    try {
        const players = await contract.getPlayers();
        document.getElementById("players").innerText = "ç©å®¶: " + (players.length ? players.join(", ") : "æš‚æ— ç©å®¶");
        const balance = await provider.getBalance(contractAddress);
        document.getElementById("balance").innerText = "å¥–æ± ä½™é¢: " + ethers.formatEther(balance) + " ETH";
    } catch(err) { console.error(err); }
}

function startAutoRefresh() {
    if (refreshInterval) clearInterval(refreshInterval);
    refreshInterval = setInterval(updatePlayersAndBalance, 5000);
}

function showConfetti() {
    for (let i=0;i<50;i++){
        const confetti = document.createElement("div");
        confetti.classList.add("confetti");
        confetti.style.left = Math.random() * window.innerWidth + "px";
        confetti.style.top = "-10px";
        confetti.style.backgroundColor = `hsl(${Math.random()*360}, 100%, 50%)`;
        confetti.style.width = confetti.style.height = 5 + Math.random()*10 + "px";
        document.body.appendChild(confetti);
        setTimeout(()=>confetti.remove(),2000);
    }
}

// ç½‘ç»œæç¤ºï¼Œä¸é˜»æ­¢æ“ä½œ
async function checkNetwork() {
    const network = await provider.getNetwork();
    if (network.chainId !== contractNetworkId) {
        document.getElementById("networkStatus").innerText =
            `å½“å‰é’±åŒ…ç½‘ç»œï¼š${network.name}(${network.chainId})ï¼Œåˆçº¦éƒ¨ç½²ç½‘ç»œä¸º Sepolia`;
    } else {
        document.getElementById("networkStatus").innerText = "";
    }
    return true;
}

// è¿æ¥é’±åŒ…
document.getElementById("connectWallet").onclick = async () => {
    if (!window.ethereum) { alert("æœªæ£€æµ‹åˆ° MetaMaskï¼"); setStatus("æœªæ£€æµ‹åˆ°é’±åŒ…"); return; }
    try {
        provider = new ethers.BrowserProvider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = await provider.getSigner();
        contract = new ethers.Contract(contractAddress, contractABI, signer);
        const user = await signer.getAddress();
        setStatus("é’±åŒ…å·²è¿æ¥: " + user);
        await checkNetwork();
        updatePlayersAndBalance();
        startAutoRefresh();

        contract.on("WinnerPicked", (winner) => {
            document.getElementById("winner").innerText = "ğŸ† è·å¥–è€…: " + winner;
            showConfetti();
            updatePlayersAndBalance();
        });
    } catch(err){ console.error(err); setStatus("è¿æ¥é’±åŒ…å‡ºé”™: " + err.message); }
};

// å‚ä¸æŠ½å¥–
document.getElementById("enterLottery").onclick = async () => {
    if (!contract) { alert("è¯·å…ˆè¿æ¥é’±åŒ…"); return; }
    await checkNetwork();
    const ethInput = parseFloat(document.getElementById("ethAmount").value);
    if (!ethInput || ethInput < 0.01) { alert("æœ€å°‘ 0.01 ETH"); return; }
    try {
        const tx = await contract.enter({ value: ethers.parseEther(ethInput.toString()) });
        setStatus("äº¤æ˜“å‘é€ä¸­...");
        await tx.wait();
        setStatus("å·²å‚ä¸æŠ½å¥–ï¼");
        updatePlayersAndBalance();
    } catch(err){ console.error(err); setStatus("å‡ºé”™: " + err.message); }
};

// å¹¸è¿è½¬è½¬è½¬
document.getElementById("pickWinner").onclick = async () => {
    if (!contract) { alert("è¯·å…ˆè¿æ¥é’±åŒ…"); return; }
    await checkNetwork();
    try {
        const managerAddress = await contract.manager();
        const currentAddress = await signer.getAddress();
        if (currentAddress.toLowerCase() !== managerAddress.toLowerCase()) {
            alert("åªæœ‰ç®¡ç†å‘˜å¯ä»¥æŠ½å¥–ï¼");
            return;
        }
        const tx = await contract.pickWinner();
        setStatus("æ­£åœ¨æŠ½å¥–...");
        await tx.wait();
        setStatus("å·²é€‰å‡ºè·å¥–è€…ï¼æ­å–œä¸­å¥–ğŸ‰");
        updatePlayersAndBalance();
    } catch(err){ console.error(err); setStatus("å‡ºé”™: " + err.message); }
};
</script>
</body>
</html>
